<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>jQuery.getJSON demo</title>
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>
<body>
  
  <select id="platforms-dropdown" name="platforms"></select>
  <script>
    let platforms = $('#platforms-dropdown');
    platforms.empty();
    platforms.append('<option selected="true" value="all">Choose Platform</option>');
    platforms.prop('selectedIndex', 0);
    const platform_url = 'https://versionhistory.googleapis.com/v1/chrome/platforms';
    $.getJSON(platform_url, function (data) {
        $.each(data.platforms, function (key, entry) {
            platform = entry.platformType.toLowerCase();
            platforms.append($('<option></option>').attr('value', platform).text(platform));
  })
});
  </script>
  
  <select id="channels-dropdown" name="channels"></select>
  <script>
    let channels = $('#channels-dropdown');
    channels.empty();
    channels.append('<option selected="true" value="all">Choose Channel</option>');
    channels.prop('selectedIndex', 0);
    const channel_url = 'https://versionhistory.googleapis.com/v1/chrome/platforms/all/channels';
    let uniquechannels = [];
    $.getJSON(channel_url, function (data) {
        $.each(data.channels, function (key, entry) {
            channel = entry.channelType.toLowerCase();
            if(jQuery.inArray(channel, uniquechannels) == -1) {
                channels.append($('<option></option>').attr('value', channel).text(channel));
                uniquechannels.push(channel);
            }
  })
});
  </script>
  
  <select id="versions-dropdown" name="versions"></select>
  <button type="button" onclick="onClick()">Update</button>
  <script>
    let versions = $('#versions-dropdown');
    versions.empty();
    versions.append('<option selected="true" value="all">Choose Version</option>');
    versions.prop('selectedIndex', 0);
    const version_url = 'https://versionhistory.googleapis.com/v1/chrome/platforms/all/channels/all/versions';
    let uniqueversions = [];
    $.getJSON(version_url, function (data) {
        $.each(data.versions, function (key, entry) {
            if(jQuery.inArray(entry.version, uniqueversions) == -1) {
                versions.append($('<option></option>').attr('value', entry.version).text(entry.version));
                uniqueversions.push(entry.version);
            }
  })
});
  </script>
  <script>
  function onClick() {
    $('#releases').find('tbody').detach();
    $('#releases').append($('<tbody><tr></tr></tbody>'));
    let selected_platform = $('#platforms-dropdown').val();
    let selected_channel = $('#channels-dropdown').val();
    let selected_version = $('#versions-dropdown').val();
  
    if (!selected_platform) {
      selected_platform = 'all';
    }
    if (!selected_channel) {
      selected_channel = 'all';
    }
    if (!selected_version) {
      selected_version = 'all';
    }
    
    console.log(selected_platform, selected_channel, selected_version);
    
    let releases_url = `https://versionhistory.googleapis.com/v1/chrome/platforms/${selected_platform}/channels/${selected_channel}/versions/${selected_version}/releases?order_by=starttime desc`
    console.log(releases_url);
    $.getJSON(releases_url, function (data) {
        $.each(data.releases, function (key, entry) {
            let values = entry.name.split('/');
            let platform = values[2];
            let channel = values[4];
            let version = entry.version;
            let fraction = entry.fraction;
            if (!fraction) {
              fraction = 'n/a';
            } else {
              fraction = `${fraction*100}%`;
            }
            let started = entry.serving.startTime;
            let ended = entry.serving.endTime;
            if (!ended) {
              ended = '-';
            }
            let td_string = `<tr><td>${platform}</td><td>${channel}</td><td>${version}</td><td>${fraction}</td><td>${started}</td><td>${ended}</td></tr>`
            $('#releases > tbody tr:last').after(td_string);
        })
  
    })
  }
    </script>
    <br><br>
    <table id="releases" style="text-align:right" border="1">
      <thead>
        <tr>
          <th>Platform</th>
          <th>Channel</th>
          <th>Version</th>
          <th>Fraction</th>
          <th>Started</th>
          <th>Ended</th>
        </tr>
      </thead>
      <tbody><tr></tr></tbody>
    </table>
</body>
</html>
